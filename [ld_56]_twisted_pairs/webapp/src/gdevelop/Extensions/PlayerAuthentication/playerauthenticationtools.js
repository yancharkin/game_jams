var gdjs;(function(u){const r=new u.Logger("Player Authentication"),g=u.playerAuthenticationComponents;let X;(function(s){let p=null,T=null,b=null,O=!1,v=!1,D=null,A=null,k=null,W=null,f=null,d=null,j=null,S=null,I=null,C=null,m=null;const Y=e=>{B(e)==="web"&&(N(),I=t=>{_({runtimeScene:e,event:t,checkOrigin:!0})},window.addEventListener("message",I,!0),r.info("Notifying parent window that player authentication is ready."),window.parent.postMessage({id:"playerAuthReady"},"*"),j=setTimeout(()=>{r.info("Removing automatic games platform authentication listener."),N()},3e3))},Z=e=>{const t=e.getGame().getAdditionalOptions();if(t&&t.isPreview){const n=t.playerId,i=t.playerToken,o=t.playerUsername;n&&i&&(r.info(`Automatically logging in the player with ID ${n} as it's a preview.`),x({userId:n,username:o||null,userToken:i}),q(e))}};u.registerRuntimeScenePostEventsCallback(()=>{O=!1}),u.registerFirstRuntimeSceneLoadedCallback(e=>{Z(e),Y(e)});const M=e=>`${e}_authenticatedUser`,U=({runtimeGame:e,gameId:t,connectionId:n,authWindowOptions:i})=>{const o="https://gd.games",a=new URLSearchParams;if(a.set("gameId",t),n&&a.set("connectionId",n),e.isUsingGDevelopDevelopmentEnvironment()&&a.set("dev","true"),a.set("allowLoginProviders","true"),i)for(const[l,c]of Object.entries(i))a.set(l,c.toString());return`${o}/auth?${a.toString()}`},B=e=>e.getGame().getRenderer().getElectron()?"electron":ee(e)?"web-iframe":typeof cordova!="undefined"?"cordova-websocket":"web",ee=e=>{const t=e.getGame().getAdditionalOptions();return t&&t.isPreview&&t.allowAuthenticationUsingIframeForPreview};s.isAuthenticated=()=>(v||R(),b!==null),s.hasLoggedIn=()=>O,s.getUsername=()=>(v||R(),p||""),s.getUserToken=()=>(v||R(),b||null),s.getUserId=()=>(v||R(),T||"");const H=(e,t,n=0)=>{const o=`${e.isUsingGDevelopDevelopmentEnvironment()?"https://api-dev.gdevelop.io":"https://api.gdevelop.io"}/game/public-game/${t}`;return fetch(o,{method:"HEAD"}).then(a=>a.status!==200?(r.warn(`Error while fetching the game: ${a.status} ${a.statusText}`),a.status===404||n>2?!1:H(e,t,n+1)):!0,a=>(r.error("Error while fetching game:",a),!1))};s.logout=e=>{p=null,b=null,T=null;const t=u.projectData.properties.projectUuid;if(!t){r.error("Missing game id in project properties.");return}window.localStorage.removeItem(M(t)),G(e),s.removeAuthenticationBanner(e);const n=e.getGame().getRenderer().getDomElementContainer();if(!n){h(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}g.displayLoggedOutNotification(n)};const R=()=>{const e=u.projectData.properties.projectUuid;if(!e){r.error("Missing game id in project properties.");return}try{const t=window.localStorage.getItem(M(e));if(!t){v=!0;return}const n=JSON.parse(t);p=n.username,T=n.userId,b=n.userToken,v=!0}catch(t){r.warn("Unable to read authentication details from localStorage. Player authentication will not be available.",t)}},G=e=>{if(s.removeAuthenticationContainer(e),V(),m&&(r.info("Closing authentication websocket connection."),m.close(),m=null),D&&(D.close(),D=null),typeof SafariViewController!="undefined")try{SafariViewController.hide()}catch{r.info("Could not hide login window. Waiting for user to do it.")}},x=({username:e,userId:t,userToken:n})=>{e||r.warn("The authenticated player does not have a username"),p=e,T=t,b=n,O=!0;const i=u.projectData.properties.projectUuid;if(!i){r.error("Missing game id in project properties.");return}try{window.localStorage.setItem(M(i),JSON.stringify({username:p,userId:T,userToken:b}))}catch(o){r.warn("Unable to save the authentication details to localStorage. Player authentication will not be available.",o)}};s.login=({runtimeScene:e,userId:t,username:n,userToken:i})=>{x({userId:t,username:n,userToken:i}),G(e),s.removeAuthenticationBanner(e);const o=e.getGame().getRenderer().getDomElementContainer();if(!o){h(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}g.displayLoggedInNotification(o,p||"Anonymous")};const _=function({runtimeScene:e,event:t,checkOrigin:n,onDone:i}){if(!(n&&!["https://liluo.io","https://gd.games"].includes(t.origin))){if(!t.data.id)throw new Error("Malformed message");switch(t.data.id){case"authenticationResult":{if(!(t.data.body&&t.data.body.token))throw new Error("Malformed message.");s.login({runtimeScene:e,userId:t.data.body.userId,username:t.data.body.username,userToken:t.data.body.token}),P(e),i&&i("logged");break}case"alreadyAuthenticated":{if(!(t.data.body&&t.data.body.token))throw new Error("Malformed message.");x({userId:t.data.body.userId,username:t.data.body.username,userToken:t.data.body.token}),N(),q(e);break}}}},h=function(e,t){r.error(t),G(e);const n=e.getGame().getRenderer().getDomElementContainer();if(!n){h(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}g.displayErrorNotification(n),P(e)},te=e=>{V();const t=15*60*1e3;S=setTimeout(()=>{r.info("Authentication window did not send message in time. Closing it."),G(e),P(e)},t)},V=()=>{S&&clearTimeout(S)},K=function(e){const t=()=>{s.removeAuthenticationBanner(e)},n=()=>{s.openAuthenticationWindow(e)};return b?g.computeAuthenticatedBanner(n,t,p):g.computeNotAuthenticatedBanner(n,t)};s.displayAuthenticationBanner=function(e){if(d){d.style.opacity="1";return}v||R();const t=e.getGame().getRenderer().getDomElementContainer();if(!t){h(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}d=K(e),t.appendChild(d)};const q=function(e){if(!d)return;const t=e.getGame().getRenderer().getDomElementContainer();if(!t){h(e,"The div element covering the game couldn't be found, the authentication banner cannot be displayed.");return}const n=d;d=K(e),t.replaceChild(d,n)},z=(e,t,n)=>new Promise(i=>{let o=!1;const a=e.getGame().isUsingGDevelopDevelopmentEnvironment()?`wss://api-ws-dev.gdevelop.io/play?gameId=${t}&connectionType=login`:`wss://api-ws.gdevelop.io/play?gameId=${t}&connectionType=login`;m=new WebSocket(a),m.onopen=()=>{r.info("Opened authentication websocket connection."),m&&m.send(JSON.stringify({action:"getConnectionId"}))},m.onerror=()=>{r.info("Error in authentication websocket connection."),o||(o=!0,i("errored")),h(e,"Error while connecting to the authentication server.")},m.onclose=()=>{r.info("Closing authentication websocket connection."),o||(o=!0,i("dismissed"))},m.onmessage=l=>{if(l.data){const c=JSON.parse(l.data);switch(c.type){case"authenticationResult":{const w=c.data;s.login({runtimeScene:e,userId:w.userId,username:w.username,userToken:w.token}),P(e),o=!0,i("logged");break}case"connectionId":{const y=c.data.connectionId;if(!y){r.error("No WebSocket connectionId received"),o=!0,i("errored");return}r.info("WebSocket connectionId received."),n({connectionId:y,resolve:i});break}}}}}),oe=(e,t,n)=>z(e,t,({connectionId:i})=>{const o=U({runtimeGame:e.getGame(),gameId:t,connectionId:i,authWindowOptions:n}),a=e.getGame().getRenderer().getElectron(),l=()=>a.shell.openExternal(o);l(),f&&g.addAuthenticationUrlToTextsContainer(l,f)}),ie=(e,t,n)=>z(e,t,({connectionId:i,resolve:o})=>{const a=U({runtimeGame:e.getGame(),gameId:t,connectionId:i,authWindowOptions:n});SafariViewController.isAvailable(function(l){l?SafariViewController.show({url:a,hidden:!1,animated:!0,transition:"slide",enterReaderModeIfAvailable:!1,barColor:"#000000",tintColor:"#ffffff",controlTintColor:"#ffffff"},function(c){c.event==="closed"&&o("dismissed")},function(c){r.log("Error opening webview: "+JSON.stringify(c)),o("errored")}):(r.error("Plugin SafariViewController is not available"),o("errored"))})}),ae=(e,t,n)=>new Promise(i=>{const o=U({runtimeGame:e.getGame(),gameId:t,authWindowOptions:n});let a=!1;C=F=>{_({runtimeScene:e,event:F,checkOrigin:!0,onDone:L=>{a||(a=!0,i(L))}})},window.addEventListener("message",C,!0);const l=screen.width/2-500/2,c=screen.height/2-600/2,w=`left=${l},top=${c},width=500,height=600`,y=()=>{D=window.open(o,"authentication",w)};y(),f&&g.addAuthenticationUrlToTextsContainer(y,f)}),re=(e,t,n)=>new Promise(i=>{if(!W||!k||!f){r.error("Can't open an authentication iframe - no iframe container, loader container or text container was opened for it.");return}const o=U({runtimeGame:e.getGame(),gameId:t,authWindowOptions:n});C=a=>{_({runtimeScene:e,event:a,checkOrigin:!0,onDone:i})},window.addEventListener("message",C,!0),g.displayIframeInsideAuthenticationContainer(W,k,f,o)});s.openAuthenticationWindow=(e,t={disableGuestLogin:!1})=>new u.PromiseTask(new Promise(n=>{const i=e.getGame().getRenderer().getDomElementContainer();if(!i){h(e,"The div element covering the game couldn't be found, the authentication window cannot be displayed."),n({status:"errored"});return}const o=u.projectData.properties.projectUuid;if(!o){h(e,"The game ID is missing, the authentication window cannot be opened."),n({status:"errored"});return}let a=!1;const l=()=>{G(e),s.displayAuthenticationBanner(e),a=!0,n({status:"dismissed"})};d&&(d.style.opacity="0");const c=B(e),{rootContainer:w,loaderContainer:y,iframeContainer:F}=g.computeAuthenticationContainer(l);A=w,k=y,W=F,i.appendChild(A),(async()=>{const L=await H(e.getGame(),o);if(k){const Q=e.getGame().getRenderer().getElectron(),de=Q?()=>Q.shell.openExternal("https://wiki.gdevelop.io/gdevelop5/publishing/web"):null;f=g.addAuthenticationTextsToLoadingContainer(k,c,L,de)}if(!L)return;te(e);let E;switch(c){case"electron":E=await oe(e,o,t);break;case"cordova-websocket":E=await ie(e,o,t);break;case"web-iframe":E=await re(e,o,t);break;case"web":default:E=await ae(e,o,t);break}a||(E==="dismissed"&&l(),n({status:E}))})()})),s.isAuthenticationWindowOpen=function(){return!!A},s.removeAuthenticationContainer=function(e){ce();const t=e.getGame().getRenderer().getDomElementContainer();if(!t){r.info("The div element covering the game couldn't be found, the authentication must be already closed.");return}A&&t.removeChild(A),A=null,k=null,W=null,f=null};const ce=function(){C&&(window.removeEventListener("message",C,!0),C=null)},N=function(){I&&(window.removeEventListener("message",I,!0),I=null),j&&(clearTimeout(j),j=null)};s.removeAuthenticationBanner=function(e){if(!d){r.info("The authentication banner couldn't be found, the authentication banner must be already closed.");return}const t=e.getGame().getRenderer().getDomElementContainer();if(!t){r.info("The div element covering the game couldn't be found, the authentication must be already closed.");return}t.removeChild(d),d=null};const P=function(e){const t=e.getGame().getRenderer().getCanvas();t&&t.focus()}})(X=u.playerAuthentication||(u.playerAuthentication={}))})(gdjs||(gdjs={}));
//# sourceMappingURL=playerauthenticationtools.js.map
